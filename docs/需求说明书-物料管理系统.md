# 物料管理系统（工厂）- 需求说明书（V0.1 草案）

本文档旨在明确工厂物料管理系统的业务范围、角色权限、功能需求、非功能需求、数据模型、接口需求、端侧适配与部署要求，作为后续设计与开发的依据。本版为草案，供评审与迭代。

## 1. 目标与范围
- 目标：建设一个支持 PC/平板/手机自适应的 Web 物料管理系统，覆盖物料主数据、库存台账、入库/出库/退库/调拨、盘点、预警、权限与审计。后端数据库本地部署，并对外提供开放 API 以便与第三方系统集成。
- 不在本期范围：
  - 复杂财务核算（移动加权/标准成本以外的多成本账）、MRP 排产、WMS 仓储设备联动、条码打印模板设计器（可预留接口）。

## 2. 角色与权限
- 超级管理员（SysAdmin）：系统参数、组织、人员、角色、权限、字典、备份与恢复。
- 仓库管理员（WH Admin）：仓库与库位、初始建账、盘点、调拨审核、异常处理。
- 采购员（Buyer）：入库申请（采购到货）、退货出库、供应商维护。
- 生产领料员（Issuer）：生产领料出库、退库、用料记录。
- 审核员（Auditor）：对关键业务单据进行审核（可按单据类型分配权限）。
- 访客/查询（Viewer）：查询报表/看板，不能编辑。

权限模型建议：RBAC（角色-权限-资源），资源精细到模块与动作（view/create/update/delete/audit/export/import），并支持按仓库、物料分类、组织维度做数据范围控制。

## 3. 功能需求
### 3.1 物料主数据（Master Data）
- 字段：物料编码、名称、规格型号、单位、条码/二维码、物料分类、批次管理标识、有效期/保质期、危化标识、存储条件、最小/最大库存、图片/附件、启用停用。
- 操作：新增/编辑/禁用、批量导入导出（Excel/CSV）、唯一性校验（编码/条码）。

### 3.2 仓库与库位
- 仓库：编码、名称、地址、负责人、启用。
- 库位：按仓库分层；可配置库位编码规则；支持温区/危险品区标记。

### 3.3 库存与批次/效期
- 实时库存：按 物料-仓库-库位-批次 维度管理可用量、在途量、锁定量。
- 批次与效期：记录批号、生产日期、有效期至，先进先出（FIFO）或 FEFO（先到期先出）策略。

### 3.4 入库（采购入库/退库入库/盘盈）
- 单据字段：单号、来源（采购单/退库/盘盈）、供应商、到货日期、行项目（物料、数量、批次、效期、单价可选）、附件。
- 流程：制单 -> 审核 -> 上架（可选）。

### 3.5 出库（生产领料/销售出库/退货/盘亏）
- 单据字段：单号、用途（工单/部门/客户）、行项目（物料、数量、批次规则：系统建议批次）、拣配/下架。
- 流程：制单 -> 审核 -> 下架。

### 3.6 调拨与锁定
- 仓内库位调拨、跨仓调拨；支持占用锁定（为工单预留）。

### 3.7 盘点
- 盘点计划：按仓库/库位/物料范围生成盘点任务。
- 盘点执行：移动端录入实盘数；生成盘盈/盘亏调整单。

### 3.8 预警与看板
- 库存上下限预警、效期将到预警、滞销预警。
- 看板：今日入库/出库、库存 TopN、预警列表，支持导出。

### 3.9 审批与日志
- 单据审核流（可配置是否需要一审/二审）。
- 操作审计日志（登录、数据变更、审批轨迹、API 调用）。

### 3.10 系统管理
- 用户、角色、组织架构、权限分配。
- 字典与参数：计量单位、物料分类、批次策略、编号规则。
- 备份与恢复：定时备份数据库，离线恢复指引。

## 4. 非功能需求
- 响应式 UI：PC/Pad/Phone 自适应。
- 性能：常用列表 < 2s；高并发（读多写少场景）保障 200 并发读、50 并发写的可扩展性（本地部署可用垂直扩展+读写分离预留）。
- 安全：基于 JWT 的会话；HTTPS（反向代理）；密码加密存储；细粒度权限校验；防止越权；审计日志留存 1 年。
- 可用性：关键操作幂等；长事务避免；异常回滚；支持断点续传（导入）。
- 兼容性：主流浏览器最新版，iOS/Android WebView。

## 5. 数据模型（初稿）
- material（物料）：id、code、name、spec、uom、category_id、barcode、is_batch、shelf_life_days、is_dg、storage_cond、min_qty、max_qty、image_url、enabled、created_at、updated_at
- warehouse（仓库）：id、code、name、address、manager_id、enabled
- location（库位）：id、warehouse_id、code、zone、temp_zone、enabled
- stock（库存快照）：id、material_id、warehouse_id、location_id、batch_no、mfg_date、exp_date、qty_on_hand、qty_allocated、qty_in_transit、locked
- inbound_order（入库单，主表）：id、code、source_type、supplier_id、arrive_date、status、created_by、approved_by
- inbound_item（入库行）：id、order_id、material_id、batch_no、exp_date、qty、uprice
- outbound_order / outbound_item（出库同上）
- transfer_order / transfer_item（调拨）
- inventory_count / inventory_count_item（盘点）
- user / role / role_permission / user_role / api_token
- supplier、customer、department（按需简化）

索引建议：
- stock(material_id, warehouse_id, location_id, batch_no)
- inbound_item(order_id, material_id, batch_no)
- outbound_item(order_id, material_id, batch_no)

并发与一致性：
- 采用“写入明细 + 库存结存表更新”的双表模型；
- 更新库存表时使用悲观/乐观锁（version 字段）；
- 保持出入库明细为事实表不可更改，仅允许红冲。

## 6. 开放 API（对外）
- 鉴权：API Key 或 OAuth2 Client Credentials（首期建议 API Key + IP 白名单）。
- 主要接口：
  - GET /api/materials：查询物料主数据（分页、过滤、支持按更新时间增量）。
  - GET /api/stocks：查询当前库存（按物料/仓库/批次过滤）。
  - POST /api/inbounds：创建入库单（支持批次/效期）。
  - POST /api/outbounds：创建出库单（支持批次策略：系统建议批次或指定批次）。
  - GET /api/orders/{code}：查询单据状态与明细。
  - Webhook：单据状态变更推送（可选）。

见 `docs/openapi.yaml` 初版规范。

## 7. 前端交互与适配
- 技术建议：React + TypeScript + Vite + Ant Design（或 Naive UI）+ Tailwind；移动端可使用 Ant Design Mobile 组件或统一响应式布局。
- 关键页面：登录、首页看板、物料主数据、库存查询（含批次）、入库、出库、调拨、盘点任务、预警、审批、系统设置。
- 表格：支持列筛选、导出、固定列；表单：支持扫码输入条码。

## 8. 后端与数据库
- 技术建议：Node.js（NestJS/Express）或 Java（Spring Boot）或 Python（FastAPI）。首期推荐 NestJS + TypeORM。
- 数据库：PostgreSQL（优先，原生支持行级锁、JSON、全文检索），或 MySQL。部署在本地服务器；提供定时备份脚本。
- 事务：单据审核时落账；异步事件用于看板与预警刷新。

## 9. 部署与运维
- 本地部署：Docker Compose（web、api、db、nginx、adminer/pgadmin）。
- 备份：每日全量 + 每小时 WAL（Postgres），保留策略可配置。
- 监控：Prometheus + Grafana（可后续）。

## 10. 合规与安全（药品场景可选）
- 留痕与审计：符合 GMP 记录可追溯要求（电子签名/双人复核可迭代）。
- 数据脱敏导出、按岗位最小权限原则。

## 11. 里程碑（建议）
- M1 原型与数据模型评审（1 周）
- M2 基础功能（主数据、入库、出库、库存）可用（3-4 周）
- M3 盘点、调拨、预警、看板（2 周）
- M4 权限、审计、对外 API 稳定（2 周）
- M5 部署与联调、试运行（1-2 周）

---
本文档为首版草案，请评审字段与流程，如有药品/危化特殊合规需求，可再细化批次、效期、质量状态与留样流程。
